<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-tags-post-list-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.0">
<title data-rh="true">One post tagged with &quot;Java&quot; | Personal website</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://javier.monton.info/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://javier.monton.info/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://javier.monton.info/blog/tags/java"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:title" content="One post tagged with &quot;Java&quot; | Personal website"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="/img/faviconblue.ico"><link data-rh="true" rel="canonical" href="https://javier.monton.info/blog/tags/java"><link data-rh="true" rel="alternate" href="https://javier.monton.info/blog/tags/java" hreflang="en"><link data-rh="true" rel="alternate" href="https://javier.monton.info/blog/tags/java" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Personal website RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Personal website Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-02W5S6K82N"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-02W5S6K82N",{})</script><link rel="stylesheet" href="/assets/css/styles.3e2f97bf.css">
<script src="/assets/js/runtime~main.15011af7.js" defer="defer"></script>
<script src="/assets/js/main.2d3f926b.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo-blue.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo-blue.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Home</b></a><a class="navbar__item navbar__link" href="/cv">CV</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/JavierMonton/blog" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/kafka-reassign-partitions">Kafka - Reassign Partitions</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/kafka-connect-mm2-offset-management">Kafka Connect, MM2, and Offset Management</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/kafka-connect-jdbc-sink-iam-auth">Kafka Connect - JDBC Sink</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/big-data-types-library">Big Data Types Library</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="https://schema.org/Blog"><header class="margin-bottom--xl"><h1>One post tagged with &quot;Java&quot;</h1><a href="/blog/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="This post is about Kafka Connect, Mirror Maker 2, how they manage offsets, and how to deal with them."><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/kafka-connect-mm2-offset-management">Kafka Connect, MM2, and Offset Management</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-04-13T00:00:00.000Z" itemprop="datePublished">April 13, 2024</time> · <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/JavierMonton" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/JavierMonton.png" alt="Javier Montón" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/JavierMonton" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Javier Montón</span></a></div><small class="avatar__subtitle" itemprop="description">Software Engineer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>This post is about Kafka Connect, Mirror Maker 2, how they manage offsets, and how to deal with them.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="kafka-offsets">Kafka Offsets<a href="#kafka-offsets" class="hash-link" aria-label="Direct link to Kafka Offsets" title="Direct link to Kafka Offsets">​</a></h2>
<p>When a consumer starts consuming messages from Kafka, it will probably use a <code>consumer-group</code> and Kafka will store the
offset of the last message consumed by that consumer-group. This offset is stored in a Kafka topic called <code>__consumer_offsets</code>.</p>
<p>By doing this, when the consumer restarts, it can start consuming messages from the last offset it consumed.</p>
<p>There are tools that allow us to manage these offsets, like the binary files provided by Kafka, and in any case,
the consumer can always decide which offsets to consume from. This means that the consumer can set the offset to the beginning,
the end, or any other offset. A lot of tools allow even to search offsets based on timestamps.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="monitoring-offset-lag">Monitoring offset lag<a href="#monitoring-offset-lag" class="hash-link" aria-label="Direct link to Monitoring offset lag" title="Direct link to Monitoring offset lag">​</a></h3>
<p>The <code>consumer-offset-lag</code> is a metric provided by Kafka, based on the difference between the last offset consumed by the consumer
and the last offset produced by the producer. Most of the monitoring tools will have this value, like DataDog,
and it is very useful to know if the consumer is lagging, meaning that it is not consuming messages as fast as they are produced, or it is down.</p>
<p>But <strong><strong>Mirror Maker 2 (MM2) can not be monitored through this metric</strong></strong>, see below.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="kafka-connect-offsets">Kafka Connect Offsets<a href="#kafka-connect-offsets" class="hash-link" aria-label="Direct link to Kafka Connect Offsets" title="Direct link to Kafka Connect Offsets">​</a></h2>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>When we talk about Kafka Connect, we are talking about the distributed version of Kafka Connect, not the standalone version.</p></div></div>
<p>Kafka Connect manage offsets in their own way. When a consumer is started by Kafka Connect, it will store the offsets in a Kafka topic
called <code>connect-offsets</code> by default, although it can be configured through the <code>offset.storage.topic</code> property.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>When a connector is created in Kafka Connect, it will track the offsets in its own topic, but it also will use a regular &quot;consumer-group&quot; so the offsets will be also tracked in <code>__consumer_offsets</code>.
This also means that we can monitor Kafka Connect sinks through the <code>consumer-offset-lag</code> metric.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="mirror-maker-2-mm2-offsets">Mirror Maker 2 (MM2) Offsets<a href="#mirror-maker-2-mm2-offsets" class="hash-link" aria-label="Direct link to Mirror Maker 2 (MM2) Offsets" title="Direct link to Mirror Maker 2 (MM2) Offsets">​</a></h2>
<p>Mirror Maker 2 is a tool provided by Kafka to replicate messages from one Kafka cluster to another, it is meant to be used for a complete replication between clusters,
but it can be used to copy only some topics.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>MM2 can be run in different ways, but here we are talking about the <code>Kafka Connect</code> way, where MM2 is run as a Kafka Connect connector.</p></div></div>
<p>If we think about MM2 and the data it needs to consume and produce, we can have doubts about how offsets can be managed.
To start with, it needs to read in one cluster and write on another, so, how does it manage the offsets?</p>
<p>By default, MM2 will create a topic called <code>mm2-offset-syncs.&lt;cluster-alias&gt;.internal</code> and as far asI know, it can not be renamed.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>While working with MM2, it is recommended to install the connectors in the &quot;target&quot; cluster, so the &quot;source&quot; cluster will be the external one.</p></div></div>
<p>By default, MM2 will create the aforementioned topic in the &quot;source&quot; cluster, and it will store the offsets of the last message consumed and produced.
But as we can see, the &quot;source&quot; cluster is &quot;external&quot; to where the Kafka Connect is installed, and that might cause some issues
in cases where the &quot;source&quot; cluster is not managed by us. For example, we might not have write or create access, and we can not create the topic.</p>
<p>The destination of <code>mm2-offset-syncs.&lt;cluster-alias&gt;.internal</code> can be defined by the <a href="https://kafka.apache.org/documentation/#mirror_source_offset-syncs.topic.location" target="_blank" rel="noopener noreferrer"><code>offset-syncs.topic.location</code> property</a> which accepts <code>source</code> (default) and <code>target</code>.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>When a Consumer is created by MM2, which is a Kafka Connect connector, it will store the offsets both in <code>mm2-offset-syncs.&lt;cluster-alias&gt;.internal</code> and in <code>connect-offsets</code>.
This is very important if we want to manipulate offsets</p></div></div>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>MM2 consumers do not use a <code>group.id</code>, they do not use any Kafka consumer group and their consumed offset won&#x27;t be stored in <code>__consumer_offsets</code>.
This also means that we can not monitor MM2 through the <code>consumer-offset-lag</code> metric.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="mixing-kafka-connect-and-mm2">Mixing Kafka Connect and MM2<a href="#mixing-kafka-connect-and-mm2" class="hash-link" aria-label="Direct link to Mixing Kafka Connect and MM2" title="Direct link to Mixing Kafka Connect and MM2">​</a></h2>
<p>If we look at the offsets stored both by Kafka Connect and MM2 in their topics, we can see the following:</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="kafka-connect-topic">Kafka Connect topic<a href="#kafka-connect-topic" class="hash-link" aria-label="Direct link to Kafka Connect topic" title="Direct link to Kafka Connect topic">​</a></h3>
<p>If we look at the <code>connect-offsets</code> topic, we can see that the offsets are stored in JSON format, with the following structure:</p>
<ul>
<li><code>key</code> is a structure that contains the connector name, the partition, the topic, and the cluster.</li>
</ul>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	&quot;my-connector-name&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		&quot;cluster&quot;: &quot;my-source-cluster-alias&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		&quot;partition&quot;: 3,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		&quot;topic&quot;: &quot;my-example-topic&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>And the <code>value</code> is a JSON with the offset:</li>
</ul>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;offset&quot;: 1234</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>No matter where we store the offsets (source or target), Kafka Connect will show the &quot;source cluster alias&quot; as this is where the Kafka consumer is created.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="mm2-topic">MM2 topic<a href="#mm2-topic" class="hash-link" aria-label="Direct link to MM2 topic" title="Direct link to MM2 topic">​</a></h3>
<p>If we look at the <code>mm2-offset-syncs.&lt;cluster-alias&gt;.internal</code> topic, we can see KC uses its own format to store the offsets:</p>
<ul>
<li><code>key</code> is the connector name, but it has a few extra bytes, which represents some structure defined inside the code</li>
<li><code>value</code> is just an Int64, which represents the offset</li>
</ul>
<p>Managing offsets is not really recommended as we could mess up the connectors, but it is possible to do it.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="hot-to-reset-offsets-in-mirror-maker-2">Hot to reset offsets in Mirror Maker 2<a href="#hot-to-reset-offsets-in-mirror-maker-2" class="hash-link" aria-label="Direct link to Hot to reset offsets in Mirror Maker 2" title="Direct link to Hot to reset offsets in Mirror Maker 2">​</a></h2>
<p>If we need to reset the offsets in MM2, we might think that deleting the topic <code>mm2-offset-syncs.&lt;cluster-alias&gt;.internal</code> will do the trick,
but it won&#x27;t, as offsets are also stored in Kafka Connect&#x27;s topic. So, we need to reset the offsets in both topics.</p>
<p>There is a lot of misinformation about how to reset the offsets in Kafka Connect, their docs are not very clear about it, and Kafka Connect has been lacking tools to work with it.
Typically, removing the connector and creating it with a different name will do the trick, but we might want to keep the same name.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="manual-edit-of-offsets">Manual edit of offsets<a href="#manual-edit-of-offsets" class="hash-link" aria-label="Direct link to Manual edit of offsets" title="Direct link to Manual edit of offsets">​</a></h3>
<p>We can manually produce a message in the <code>connect-offsets</code> topic to reset offsets, and the right way of doing it is to send a <code>tombstone</code>.
We can check the messages we have right now, identify the connector we want and send the same Key with <code>null</code> value.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>To reset offsets completely we do not specify <code>offset: 0</code>, we send a null value</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="rest-api-to-reset-offsets">REST API to reset offsets<a href="#rest-api-to-reset-offsets" class="hash-link" aria-label="Direct link to REST API to reset offsets" title="Direct link to REST API to reset offsets">​</a></h3>
<p>Starting from <a href="https://archive.apache.org/dist/kafka/3.6.0/RELEASE_NOTES.html" target="_blank" rel="noopener noreferrer">Kafka 3.6.0</a>, Kafka Connect has a REST API to manage connectors, and it is possible to reset offsets through it.
The docs about it are defined in the <a href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-875%3A+First-class+offsets+support+in+Kafka+Connect#KIP875:FirstclassoffsetssupportinKafkaConnect-PublicInterfaces" target="_blank" rel="noopener noreferrer">KPI-875</a>, but they are still not present in the official docs.
If you are using Confluent, starting from <a href="https://docs.confluent.io/platform/current/release-notes/index.html" target="_blank" rel="noopener noreferrer">Confluent&#x27;s 7.6.0 version</a> Kafka 3.6.0 is included.</p>
<p>If we use this version, we can simply do a few curls to reset offsets. First we need to stop the connector and then reset the offsets.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -X PUT http://localhost:8083/connectors/my-connector-name/offsets/stop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl -X DELETE http://localhost:8083/connectors/my-connector-name/offsets</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We can also know the status of the offsets:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -X GET http://localhost:8083/connectors/my-connector-name/offsets | jq</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="tldr">TL;DR<a href="#tldr" class="hash-link" aria-label="Direct link to TL;DR" title="Direct link to TL;DR">​</a></h2>
<p>To reset offsets in MM2, you need to:</p>
<ul>
<li>Stop, pause or remove the connectors</li>
<li>Delete or truncate the topic <code>mm2-offset-syncs.&lt;cluster-alias&gt;.internal</code></li>
<li>Reset the offsets in the <code>connect-offsets</code> topic, either manually or through the REST API for the desired connector</li>
<li>Start the connectors again</li>
</ul>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Deleting the topic <code>mm2-offset-syncs.&lt;cluster-alias&gt;.internal</code> will not reset the offsets for other connectors you have configured in MM2
as they fall back to the <code>connect-offsets</code> topic, but be careful and do this at your own risk, things might change in the future and this could become false.</p></div></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/scala">Scala</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/java">Java</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/kafka">Kafka</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/kafka-connect">Kafka-Connect</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/mm-2">MM2</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/offsets">offsets</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/msk">MSK</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/mirror-maker-2">Mirror-Maker2</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Blog</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li></ul></div><div class="col footer__col"><div class="footer__title">About me</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/JavierMonton" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://stackoverflow.com/users/7041871/javier-mont%c3%b3n" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/in/javiermonton/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/cv">CV</a></li><li class="footer__item"><a href="https://twitter.com/javier_monton" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Open Source / Projects</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://data-tools.github.io/big-data-types/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Big-Data-Types<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://milpartituras.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Milpartituras.com<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>