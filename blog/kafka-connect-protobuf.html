<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.0">
<title data-rh="true">Kafka Connect - Protobuf Converters | Personal website</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://javier.monton.info/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://javier.monton.info/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://javier.monton.info/blog/kafka-connect-protobuf"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Kafka Connect - Protobuf Converters | Personal website"><meta data-rh="true" name="description" content="Kafka Connect is a tool that allows you to stream data between Apache Kafka and other systems,"><meta data-rh="true" property="og:description" content="Kafka Connect is a tool that allows you to stream data between Apache Kafka and other systems,"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2025-02-22T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/JavierMonton"><meta data-rh="true" property="article:tag" content="kafka-connect,protobuf,source,sink,schema-registry"><link data-rh="true" rel="icon" href="/img/faviconblue.ico"><link data-rh="true" rel="canonical" href="https://javier.monton.info/blog/kafka-connect-protobuf"><link data-rh="true" rel="alternate" href="https://javier.monton.info/blog/kafka-connect-protobuf" hreflang="en"><link data-rh="true" rel="alternate" href="https://javier.monton.info/blog/kafka-connect-protobuf" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Personal website RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Personal website Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-02W5S6K82N"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-02W5S6K82N",{})</script><link rel="stylesheet" href="/assets/css/styles.8a6e474c.css">
<script src="/assets/js/runtime~main.629633aa.js" defer="defer"></script>
<script src="/assets/js/main.eadd0022.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo-blue.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo-blue.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Home</b></a><a class="navbar__item navbar__link" href="/cv">CV</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/JavierMonton/blog" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/kafka-connect-protobuf">Kafka Connect - Protobuf Converters</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/kafka-reassign-partitions">Kafka - Reassign Partitions</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/kafka-connect-mm2-offset-management">Kafka Connect, MM2, and Offset Management</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/kafka-connect-jdbc-sink-iam-auth">Kafka Connect - JDBC Sink</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/big-data-types-library">Big Data Types Library</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="https://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="Kafka Connect is a tool that allows you to stream data between Apache Kafka and other systems,"><header><h1 class="title_f1Hy" itemprop="headline">Kafka Connect - Protobuf Converters</h1><div class="container_mt6G margin-vert--md"><time datetime="2025-02-22T00:00:00.000Z" itemprop="datePublished">February 22, 2025</time> · <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/JavierMonton" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/JavierMonton.png" alt="Javier Montón" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/JavierMonton" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Javier Montón</span></a></div><small class="avatar__subtitle" itemprop="description">Software Engineer</small></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><p>Kafka Connect is a tool that allows you to stream data between Apache Kafka and other systems,
sometimes the data might be converted from Protobuf to something different, other times, it might be converted to Protobuf.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="protobuf-converters">Protobuf Converters<a href="#protobuf-converters" class="hash-link" aria-label="Direct link to Protobuf Converters" title="Direct link to Protobuf Converters">​</a></h2>
<p>Confluent has a <a href="https://docs.confluent.io/platform/current/schema-registry/connect.html#protobuf" target="_blank" rel="noopener noreferrer">Protobuf Converter</a>
that can be used with any Kafka Connect Source or Sink, but it isn&#x27;t as simple as it seems.</p>
<p>If you enable:</p>
<div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">key.converter=io.confluent.connect.protobuf.ProtobufConverter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">value.converter.schema.registry.url=http://localhost:8081</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If you use this in a Sink connector, Kafka Connect will understand how to deserialize the Protobuf message in Kafka, but how will it write it to the sink?</p>
<p>If you enable this in a Source connector, Kafka Connect will be able to serialize the message to Protobuf, but what was it expecting from the Source?</p>
<p>In some connectors, like a JDBC, it might be obvious that the database has a proper schema defined, but in others, like S3 or SQS, there is no schema defined, so, how will Kafka Connect know how to read/write the data?</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-converters-work">How Converters work<a href="#how-converters-work" class="hash-link" aria-label="Direct link to How Converters work" title="Direct link to How Converters work">​</a></h2>
<p>Inside Kafka Connect, the data is represented using the classes in <code>org.apache.kafka.connect.data</code>, which can be <code>Struct</code>,</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="sink--protobuf-converter">Sink &amp; Protobuf Converter<a href="#sink--protobuf-converter" class="hash-link" aria-label="Direct link to Sink &amp; Protobuf Converter" title="Direct link to Sink &amp; Protobuf Converter">​</a></h2>
<p>In a Sink, the ProtobufConverter (the same as the Avro converter or any other) transforms the data read from Kafka into this <a href="https://github.com/a0x8o/kafka/blob/master/connect/api/src/main/java/org/apache/kafka/connect/data/Struct.java" target="_blank" rel="noopener noreferrer">Struct</a> class, with its fields and schema.
From there, the Sink connector decides how to write these objects in the destination. If we use a destination that requires a schema, like an RDS, the connector will likely know (and probably need) how to write these <code>structs</code>.</p>
<p>If we use a plugin that writes into a schemaless system, like S3 or SQS, nothing prevents the connector from writing data other than JSON or similar.
<em>The connector needs to transform the <code>struct</code> into JSON if that&#x27;s what we want</em>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="source--protobuf-converter">Source &amp; Protobuf Converter<a href="#source--protobuf-converter" class="hash-link" aria-label="Direct link to Source &amp; Protobuf Converter" title="Direct link to Source &amp; Protobuf Converter">​</a></h2>
<p>Here is where it gets tricky. If we use a Protobuf converter in a Source connector, we are telling the converter to transform the <code>Struct</code> into Protobuf, but the connector needs to produce this <code>Struct</code>.
In a structured source, like an RDS, it is easy to know how to produce the <code>Struct</code>, but in a schemaless source, like S3 or SQS, it is not that easy, the Source connector should be expecting something like a JSON, and it will need to parse it properly, generating a <code>schema</code> and a <code>struct</code>, otherwise, the Protobuf converter won&#x27;t know what to do.</p>
<p>At EF, we have <a href="https://github.com/efcloud/kafka-connect-sqs" target="_blank" rel="noopener noreferrer">modified an SQS Source connector</a> to allow automatic conversions from JSON to <code>Struct</code>, so the Protobuf or any other converter can work properly.</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Note that parsing automatically JSONs to be converted into <code>Struct</code> or <code>Protobuf</code> is not trivial due to the light types of JSON. For example, a numeric Timestamp in JSON is no different from a numeric value, so you cannot know if it&#x27;s a Timestamp or an Integer, or Long. JSON doesn&#x27;t have enums, so a String cannot be converted into an <code>Enumeration</code> automatically, etc.</p></div></div>
<p>But that&#x27;s not all, <em>how will this Protobuf Converter interact with Schema Registry?</em> There are several issues depending on the configuration.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="schema-registry--protobuf-converter">Schema Registry &amp; Protobuf Converter<a href="#schema-registry--protobuf-converter" class="hash-link" aria-label="Direct link to Schema Registry &amp; Protobuf Converter" title="Direct link to Schema Registry &amp; Protobuf Converter">​</a></h2>
<p>The Confluent&#x27;s ProtobufConverter is designed to use the following configuration, which is the default one:</p>
<div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">value.converter.auto.register.schemas=true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">value.converter.use.latest.version=false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">value.converter.latest.compatibility.strict=true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In this way, a Source Connector in Kafka Connect will produce a new Protobuf Schema, and it will register the Schema in Schema Registry.
But the schema registered will be something similar to this:</p>
<div class="language-protobuf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-protobuf codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">syntax = &quot;proto3&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">message ConnectDefault1 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  string id = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  int32 value = 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  repeated string tags = 3;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  google.protobuf.Timestamp updatedAt = 4;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ConnectDefault2 sub = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  message ConnectDefault2 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string name = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string description = 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int32 value = 3;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As we can see, it decides to create messages named <code>ConnectDefault1</code> and <code>ConnectDefault2</code>, which are fine if we don&#x27;t care much about controlling our own schemas.</p>
<p>If a new message has a different schema than the first registered, and it&#x27;s not compatible (following our compatibility configurations), it will fail.</p>
<p>But, what happens if we don&#x27;t want Kafka Connect to write the schema in Schema Registry? We could disable the option, so this will be our config:</p>
<div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">value.converter.auto.register.schemas=false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">value.converter.use.latest.version=true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">value.converter.latest.compatibility.strict=true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In this situation, we are registering the schema on our side, maybe we are calling our main object <code>MainObject</code> rather than <code>ConnectDefault1</code>. But here is where the issues start to appear, the ProtobufConverter will try to validate the schema in Schema Registry, and it will fail, because it is expecting a <code>ConnectDefault1</code> and we are sending a <code>MainObject</code>.
We could solve this by using the <a href="https://docs.confluent.io/kafka-connectors/transforms/current/setschemametadata.html#set-a-namespace-and-schema-name" target="_blank" rel="noopener noreferrer">SetSchemaMetadata SMT</a> to set the schema name and namespace. But we still have issues with the order of the fields, more details later.</p>
<p>So, maybe we can disable the <code>value.converter.latest.compatibility.strict=false</code> if we know the schemas are the same?</p>
<p>We could do it, yes, then, the ProtobufConverter won&#x27;t compare the schemas, it will serialize the message and send it to Kafka.
If the message has exactly the same schema, it will work, if not, it will still send the message to Kafka.</p>
<p>And probably <strong>the worst scenario</strong>, lets imagine that a new event comes with fields in different order. We know that the <code>Struct</code> holds information about the field names and types, so it shouldn&#x27;t cause any issue. We also know that an input message in a format like JSON also specifies the field names, so far so good.
But, Protobuf cares about the order of the fields, not just about their names, and the <code>ProtobufConverter</code> doesn&#x27;t know which the expected order.
Look at the previous Protobuf definition, a new message might come with <code>id</code> and <code>value</code> in different order, the <code>ProtobufConverter</code> will produce a schema like this:</p>
<div class="language-protobuf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-protobuf codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">syntax = &quot;proto3&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">message ConnectDefault1 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  int32 value = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  string id = 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  repeated string tags = 3;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  google.protobuf.Timestamp updatedAt = 4;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ConnectDefault2 sub = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  message ConnectDefault2 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string name = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string description = 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int32 value = 3;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>id</code> and <code>value</code> are in different order. If we have the <code>value.converter.latest.compatibility.strict</code> set to <code>true</code>, this will cause an error, if we have it as <code>false</code>, the event will be produced to Kafka, but our consumers will read it wrong.</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Even if we use <code>value.converter.latest.compatibility.strict=true</code>, if we send a message that matches the schema in the order of the fields and their types, but not on the field names, it will still produce the message. For example, if our message looks like this:</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;anotherfield&quot;: &quot;12345&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;value&quot;: 10,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;tags&quot;: [&quot;exampleTag1&quot;, &quot;exampleTag2&quot;],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;updatedAt&quot;: &quot;2023-10-01T12:34:56Z&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The <code>ProtobufConverter</code> will serialize this message and produce it in Kafka. When a consumer reads this, it will use the Schema in Schema Registry,
which has <code>id</code> rather than <code>anotherfield</code>, it will show the data on it.
This come become a big issue if our schema has a lot of fields with the same type, like <code>string</code>,
if a message has unordered fields, they will end up mixed.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2>
<p>If we are using a Source Connector with ProtobufConverter, we should use the default configuration</p>
<div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">value.converter.auto.register.schemas=false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">value.converter.use.latest.version=true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">value.converter.latest.compatibility.strict=true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>and ensure that the source messages have always the same schema, <strong>including the order of the fields</strong>.</p>
<p>Otherwise, the system becomes too fragile, we could get a lot of failures, or we could produce messages we won&#x27;t be able to read.
Even with the default configuration, we should ensure that messages in the source don&#x27;t change the order of the fields, as this will cause issues with Protobuf.</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/kafka-connect">kafka-connect</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/protobuf">protobuf</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/source">source</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/sink">sink</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/schema-registry">schema-registry</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/JavierMonton/blog/edit/main/website/blog/2025-02-22-kafka-connect-probotuf/index.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--next" href="/blog/kafka-reassign-partitions"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Kafka - Reassign Partitions</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#protobuf-converters" class="table-of-contents__link toc-highlight">Protobuf Converters</a></li><li><a href="#how-converters-work" class="table-of-contents__link toc-highlight">How Converters work</a></li><li><a href="#sink--protobuf-converter" class="table-of-contents__link toc-highlight">Sink &amp; Protobuf Converter</a></li><li><a href="#source--protobuf-converter" class="table-of-contents__link toc-highlight">Source &amp; Protobuf Converter</a></li><li><a href="#schema-registry--protobuf-converter" class="table-of-contents__link toc-highlight">Schema Registry &amp; Protobuf Converter</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Blog</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li></ul></div><div class="col footer__col"><div class="footer__title">About me</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/JavierMonton" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://stackoverflow.com/users/7041871/javier-mont%c3%b3n" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/in/javiermonton/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/cv">CV</a></li><li class="footer__item"><a href="https://twitter.com/javier_monton" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Open Source / Projects</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://data-tools.github.io/big-data-types/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Big-Data-Types<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://milpartituras.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Milpartituras.com<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>